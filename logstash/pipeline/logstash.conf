input {
  beats {
    port => 5044
  }
}

filter {
  # Parse JSON logs from Winston
  json {
    source => "message"
    target => "parsed_json"
    skip_on_invalid_json => true
  }

  # Move parsed fields to root
  mutate {
    add_field => {
      "service" => "%{[parsed_json][service]}"
      "level" => "%{[parsed_json][level]}"
      "correlationId" => "%{[parsed_json][correlationId]}"
      "log_message" => "%{[parsed_json][message]}"
    }
    remove_field => ["parsed_json"]
  }

  # Remove extra noise
  mutate {
    remove_field => ["host", "agent", "ecs", "input"]
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "smart-waste-logs-%{+YYYY.MM.dd}"
  }
  stdout {
    codec => rubydebug
  }
}
